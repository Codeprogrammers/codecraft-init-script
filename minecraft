#!/bin/bash
# /etc/init.d/minecraft
# version 0.3.12 2011-12-06 (YYYY-MM-DD)

### BEGIN INIT INFO
# Provides:   minecraft
# Required-Start: $local_fs $remote_fs
# Required-Stop:  $local_fs $remote_fs
# Should-Start:   $network
# Should-Stop:    $network
# Default-Start:  2 3 4 5
# Default-Stop:   0 1 6
# Short-Description:    Minecraft server
# Description:    Starts the minecraft server
### END INIT INFO


#Settings
USERNAME="minecraft"
SCREEN_NAME="codecraft"
BUILD="b1337"
SERVICE="craftbukkit.jar"
INVOCATION="java -Xms512M -Xmx1024M -jar craftbukkit.jar"

#File Paths
MC_PATH="/mnt/codecraft/servers/$BUILD"
RD_PATH="/mnt/codecraft/ramdisk"
WORLD_PATH="/mnt/codecraft/worlds"
WORLD_BACKUPPATH="/mnt/codecraft/archives/worlds"
SERVER_BACKUPPATH="/mnt/codecraft/archives/servers"

#Messages (sent to minecraft server console with "say" command)
SAVE_OFF_MSG="Server going readonly..."
SAVE_ON_MSG="Server going read-write..."
BACKUP_START_MSG="SERVER BACKUP STARTING"
BACKUP_DONE_MSG="SERVER BACKUP COMPLETE"
BACKUP_FAIL_MSG="SERVER BACKUP FAILED"
STOP_MSG="SERVER SHUTTING DOWN IN 15 SECONDS"
RESTART_MSG="SERVER GOING FOR RESTART"

#Grabbing world name from $MC_PATH/server.properties
WORLD_NAME=$(cat $MC_PATH/server.properties | fgrep 'level-name=' | sed -e s/.*level-name=//)

#Run commands as the user defined in the $USERNAME variable
ME=`whoami`
as_user() {
  if [ $ME == $USERNAME ]
  then
    bash -c "$1"
  else
    su - $USERNAME -c "$1"
  fi
}

#Starts the service
mc_start() {
  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
  then echo "Tried to start but $SERVICE was already running!"
  else echo "$SERVICE was not running... starting."

    as_user "cd $MC_PATH && screen -dmS $SCREEN_NAME $INVOCATION"   # Start screen session
    sleep 7                                                         # Wait 7 seconds before checking service's status

    #Check to see if the service started successfully
    if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
    then echo "$SERVICE is now running."
    else echo "Could not start $SERVICE."
    fi
  fi
}

#Disables automatic saving and saves all current changes to the worlds
mc_saveoff() {
  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
  then echo "$SERVICE is running... suspending saves"

    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $SAVE_OFF_MSG\"\015'"   # Tell the users that saving is turning off
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-off\"\015'"            # Turn saving off
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-all\"\015'"            # Save changes to the worlds
    sync; sleep 5                                                                     # Write changes to disk, Wait 5 seconds

  else echo "$SERVICE was not running. Not suspending saves."
  fi
}

#Enables automatic saving
mc_saveon() {
  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
  then echo "$SERVICE is running... re-enabling saves"

    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-on\"\015'"            # Turn auto-saving on
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $SAVE_ON_MSG\"\015'"   # Tell the users that saving is now on

  else echo "$SERVICE was not running. Not resuming saves."
  fi
}

#Stops the service
mc_stop() {
  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
  then echo "$SERVICE is running... stopping."

    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $STOP_MSG\"\015'" ; sleep 5   # Tell the users that the server is stopping, Wait 5 seconds
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-all\"\015'" ; sleep 10       # Save changes to the worlds, Wait 10 seconds
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"stop\"\015'" ; sleep 3            # Stop the server, Wait 3 seconds

  else echo "$SERVICE was not running."
  fi

  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
  then echo "$SERVICE could not be shut down... still running."
  else echo "$SERVICE is shut down."
  fi
}

#Backup the current world files
mc_world_backup() {
  echo "Backing Up Worlds"
  cd $WORLD_BACKUPPATH

  # Check for directories with the current datestamp
  if ls | grep $DATE > /dev/null
  then
    cd $DATE
  else
    as_user "mkdir $WORLD_BACKUPPATH/$DATE"
    cd $DATE
  fi

  # Check for directories with the curent timestamp.
  if ls | grep $TIME > /dev/null
  then
    TIME="$TIME"_`date "+%S"`                                     # Appened the current seconds time to $bu_time
    as_user "mkdir $WORLD_BACKUPPATH/$DATE/$TIME"                 # Make a directory with the name contained in $bu_time
    as_user "cp -a $WORLD_PATH/* $WORLD_BACKUPPATH/$DATE/$TIME"   # Copy all data from the $WORLD_PATH directory to the $bu_time directory
  else
    as_user "mkdir $WORLD_BACKUPPATH/$DATE/$TIME"                 # Make a directory with the current timestamp as the name
    as_user "cp -a $WORLD_PATH/* $WORLD_BACKUPPATH/$DATE/$TIME"   # Copy all data from the $WORLD_PATH directory to the $bu_time directory
  fi
}

#Check the integrity of the backup
mc_world_backup_cksum() {
  echo "Running a Checksum of the Backups"
  cd $WORLD_BACKUPPATH/..

  if [ -d "chksum" ]
  then cd chksum

    if [ -d "worlds" ]
    then
      rm -rf "worlds"
      as_user "mkdir $WORLD_BACKUPPATH/../chksum/worlds"
    else
      as_user "mkdir $WORLD_BACKUPPATH/../chksum/worlds"
    fi

    if [ -d "worlds_backup" ]
    then
      rm -rf "worlds_backup"
      as_user "mkdir $WORLD_BACKUPPATH/../chksum/worlds_backup"
    else
      as_user "mkdir $WORLD_BACKUPPATH/../chksum/worlds_backup"
    fi

  else
    as_user "mkdir $WORLD_BACKUPPATH/../chksum ; cd $WORLD_BACKUPPATH/../chksum"
    as_user "mkdir $WORLD_BACKUPPATH/../chksum/worlds ; mkdir $WORLD_BACKUPPATH/../chksum/worlds_backup"
  fi

  as_user "cd $WORLD_PATH ; tar -cf worlds.tar *"
  as_user "mv $WORLD_PATH/worlds.tar $WORLD_BACKUPPATH/../chksum/worlds"


  as_user "cd $WORLD_BACKUPPATH/$DATE/$TIME ; tar -cf worlds.tar *"
  as_user "mv $WORLD_BACKUPPATH/$DATE/$TIME/worlds.tar $WORLD_BACKUPPATH/../chksum/worlds_backup"

  cd $WORLD_BACKUPPATH/../chksum
  WORLD_checksum=$(ls worlds | cksum)           # Set $WORLD_checksum to the value of the checksum of the current worlds' tarball
  BACKUP_checksum=$(ls worlds_backup | cksum)   # Set $BACKUP_checksum to the value of the checksum of the newest backup's tarball


  # Compare the values of the checksums
  if [ "$WORLD_checksum" = "$BACKUP_checksum" ]
  then
    echo "Backup Complete"
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $BACKUP_DONE_MSG\"\015'"
  else
    echo "Backup failed! The source and target contents do not match!"
    echo "Worlds: $WORLD_checksum" ; echo "Backup: $BACKUP_checksum"
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $BACKUP_FAIL_MSG\"\015'"
  fi
}

mc_rd_start() {
RUN_DIR=$(dirname $0)
# exit status from mcramdisk script will determine wether
#  the ramdisk is mounted, if it is
  if $RUN_DIR/mcramdisk mount
  then

    if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null   # Is service running?
    then echo "Tried to start but $SERVICE was already running!"              # Instance exists, tell the user
    else echo "$SERVICE was not running... prepping RAMDISK."                 # Instance does not exist, tell user we are going to start it

      if [ ! -d $WORLD_PATH/$WORLD_NAME ]                                     # Checking for the  existance of a world using the name defined in server.properties
      then echo "$WORLD_NAME is not in $WORLD_PATH!"                          # If no world exists, tell the user
      else cd $WORLD_PATH                                                     # If the world does exist, cd to $WORLD_PATH

        for dir in *                                                          # For each folder in WORLD_PATH,
        do

          if [ ! -d $RD_PATH/$dir ]                                           # We are going to make sure it does not reside on the RAMDISK
          then javwc=`expr match "$dir" '.*[0-9]'`                            # Expression to filter out the world backups (ignore something ending with a number)

            if [ -d "$dir" ] && [ -f "$dir/level.dat" ] && [ $javwc -eq 0 ]   # Make sure it is a directory, and that it has a level.dat file in it, and the it IS NOT a backup
            then as_user "cp -R $dir $RD_PATH/"                               # Copy the world from $WORLD_PATH to $RD_PATH

              if [ -d $MC_PATH/$dir ]                                         # Are there folders or symlinks already in $MC_PATH?
              then as_user "mv $MC_PATH/$dir $MC_PATH/$dir.old"               # Rename them with the suffix ".old"
              fi

              as_user "ln -s $RD_PATH/$dir $MC_PATH/$dir"                     # Setup the symlinks to the worlds on the RAMDISK
            fi
          fi
        done
        mc_start                                                              # Then start the server as normal.
      fi                                                                      # Close if statement "world exist?"
    fi                                                                        # Close if statement "running?"

  else echo "Cound not start $SERVICE, ramdisk could not be mounted"
  fi                                                                         # Close if statement "RAMDISK mounted?"
}

mc_rd_save() {
  if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null    # Check if the serviec is running
  then
    if [ ! -d $RD_PATH/$WORLD_NAME ]                                         # Check if $WORLD_NAME (whatevere it was named in server.properties) exists in $RD_PATH
    then echo "Nothing in $RD_PATH to backup!"                               # Not found! Warn user!
    else
      echo "Saving ramdisk to disk."                                         # Else we have found something and will continue with the regime, warn user we are beginning
      as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-off\"\015'" # Send save-off command to the instance
      as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-all\"\015'" # Force save of world.
      sleep 3
      cd $RD_PATH                                                            # Make sure we are in the $RD_PATH for the next series of commands
      filedate=$(date +"-%F-%H.%M")                                          # Set up our datestamp here.
      for dir in *                                                           # For each directory inside $RD_PATH, we are going to perform the following series of commands
      do
        if [ -d "$dir" ] && [ -f "$dir/level.dat" ]                          # Make sure it is a directory and verify itis a world by looking for "level.dat" inside of it.
        then
          if [ -d $WORLD_PATH/$dir ]                                         # Now we check to see if the world folder we found already exists in the $WORLD_PATH
          then
            echo "Moving "$WORLD_PATH\/$dir" to "$WORLD_PATH\/$dir$filedate  # We tell the user what we are going to do
            as_user "mv "$WORLD_PATH/$dir"/ "$WORLD_PATH\/$dir$filedate      # Then rename the found folder with a datestamp on the end of it's name
          fi
          echo "$dir being copied to disk"                                   # Tell the user we are copying the RAMDISK
          as_user "cp -R $RD_PATH/$dir $WORLD_PATH/"                         # Copy the world from $RD_PATH to $WORLD_PATH
        else echo "Nothing copied from ramdisk."                             # If no world folders are found, we tell the user.
        fi
      done                                                                   # END for loop (directory inside $RD_PATH)
      as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"save-on\"\015'"  # Send "save-on" to the instance
    fi
  else echo "Nothing to save, $SERVICE is not running."                      # Service not running, nothing to save
  fi
}

#Start-Stop here
case "$1" in
  start)
    mc_start
    ;;
  stop)
    mc_stop
    ;;
  restart)
    if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
    then
      as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $RESTART_MSG\"\015'"
      mc_stop
      mc_start
    else
      mc_start
    fi
    ;;
  worldbackup)
    DATE=$(date "+%Y.%m.%d")
    TIME=$(date "+%H-%M")
    as_user "screen -p 0 -S $SCREEN_NAME -X eval 'stuff \"say $BACKUP_START_MSG\"\015'"
    mc_saveoff
    mc_world_backup
    mc_world_backup_cksum
    mc_saveon
    ;;
  status)
    if ps ax | grep -v grep | grep -v -i SCREEN | grep $SERVICE > /dev/null
    then echo "$SERVICE is running."
    else echo "$SERVICE is not running."
    fi
    ;;
  start_rd)
    # Start a RD instance
    mc_rd_start
    ;;
  rd2disk)
    # Backup RD contents
    mc_rd_save
    ;;

  *)
  echo "Usage: /etc/init.d/minecraft {start|stop|restart|status|start_rd|rd2disk|worldbackup}"
  exit 1
  ;;
esac

exit 0
